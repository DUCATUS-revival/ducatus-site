<section class="section-header-page" style="background-image: url(/assets/img/sections/vaucher-bg.png);">
    <div class="container">
        <!-- <h1 class="h1__title-page" [innerHTML]="'PAGE.VAUCHER.TITLE' | translate"></h1> -->
    </div>
</section>
<section class="app voucher">
    <div class="container">
        <div class="content-block">
            <span class="page-text-title" [innerHTML]="'PAGE.VAUCHER.TITLE' | translate">Voucher</span>
            <div class="page-btn-block">
                <span class="ducatus-btn ducatus-btn-brown" (click)="popupAdd=true">New Voucher</span>
                <label for="file" class="ducatus-btn ducatus-btn-gold" [ngClass]="{ 'icon icon__loading': loadingCSV }">
                    <span *ngIf="!loadingCSV">Importing CSV</span>
                </label>
                <input type="file" id="file" accept=".csv" (change)="parseCsvFile($event)" class="ducatus-inputs-file"
                    [disabled]="loadingCSV">
                <span class="ducatus-btn ducatus-btn-brown table-refresh" (click)="updateVouchers()"
                    [ngClass]="{ 'icon icon__refresh': !updateVouchersTable, 'icon icon__loading': updateVouchersTable }"></span>
            </div>
        </div>
        <div class="content-block">
            <div class="page-table-wrap">
                <table class="page-table">
                    <thead class="page-table-head">
                        <th style="min-width: 90px; width: 90px;" class="text-center table-sort icon"
                            [ngClass]="{'icon__sort-down': sortById, 'icon__sort-up': !sortById}"
                            (click)="sortVouchers('id')">â„–
                        </th>
                        <th style="min-width: 130px; width: 130px;" class="table-sort icon"
                            [ngClass]="{'icon__sort-down': sortByAddDate, 'icon__sort-up': !sortByAddDate}"
                            (click)="sortVouchers('add-date')">Voucher
                            <br> Add Date</th>
                        <th style="min-width: 115px; width: 115px;">Voucher <br> Add Time</th>
                        <th style="min-width: 120px;">Voucher Code</th>
                        <th style="min-width: 100px;">Activation <br> Code</th>
                        <th style="min-width: 60px;">Amount <br> (DUC)</th>
                        <th style="min-width: 80px; width: 80px;" class="text-center">Active</th>
                        <th style="min-width: 120px; width: 120px;" class="text-center">Used/<br>unused</th>
                        <th style="min-width: 130px; width: 130px;">Activated <br> Date</th>
                    </thead>
                    <tbody class="page-table-body">
                        <tr *ngFor="let item of vouchers"
                            [ngClass]="{ 'table-line-blocked': item.isProgress || false }">
                            <td class="text-center">{{ item.id }}</td>
                            <td class="page-table-text-accent">{{ item.publish_date | date:'dd.LL.y' }}</td>
                            <td>{{ item.publish_date | date:'hh:mm' }}</td>
                            <td class="voucher-voucher-code">
                                <span class="page-table-w" title="{{ item.voucher_code }}">
                                    <span *ngIf="item.voucher_code.length > 14" class="voucher-show-info"
                                        (click)="openInfoModal('Voucher code', item.voucher_code)">(?)</span>
                                    {{ item.voucher_code }}
                                </span>
                            </td>
                            <td class="voucher-activation-code">
                                <span class="page-table-w" title="{{ item.activation_code }}">
                                    <span class="voucher-show-info"
                                        (click)="openInfoModal('Activation code', item.activation_code)">(?)</span>
                                    {{ item.activation_code }}
                                </span>
                            </td>
                            <td class="voucher-ducatus-amount">
                                <span class="page-table-w" title="{{ item.duc_amount }}">
                                    <span *ngIf="item.duc_amount.toString().length > 8" class="voucher-show-info"
                                        (click)="openInfoModal('Ducatus amount', item.duc_amount + ' DUC')">(?)</span>
                                    {{ item.duc_amount }}
                                </span>
                            </td>
                            <td class="text-center">
                                <label class="ducatus-inputs-switch">
                                    <input type="checkbox" [checked]="item.is_active"
                                        (change)="changeActive(item.id, item.is_active)">
                                    <span class="ducatus-inputs-switch-slider"></span>
                                </label>
                            </td>
                            <td>
                                <span class="page-table-active"
                                    [ngClass]="{ 'page-table-active-yes': item.is_used }"></span>
                            </td>
                            <td [ngClass]="{ 'page-table-text-accent': item.activation_date ? true  : false  }">
                                {{ item.activation_date | date:'dd.LL.y' || '-' }}
                            </td>
                            <td class="page-table-blocked" *ngIf="item.isProgress || false">
                                <span
                                    class="page-table-blocked-text">{{ item.progressText || 'in progress, please wait...' }}</span>
                                <span *ngIf="item.isProgressBtn || false"
                                    class="ducatus-btn ducatus-btn-brown page-table-blocked-btn"
                                    (click)="acceptTableProgress(item.id)">ok</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>

<ng-container *ngIf="popupAdd">
    <div class="popup-voucher">
        <div class="popup-container">
            <div class="popup-header">
                <span class="popup-header-text">New Voucher</span>
                <span class="popup-close" (click)="close()">X</span>
            </div>
            <div class="popup-body">
                <div class="popup-blocked" *ngIf="pupopInProgress">
                    <span class="popup-blocked-text" [innerHTML]="this.popupInProgressText"></span>
                    <span *ngIf="popupInProgressBtn" class="ducatus-btn ducatus-btn-brown"
                        (click)="acceptPopupProgress()">ok</span>
                </div>
                <form #voucherAddForm="ngForm" novalidate class="popup-form">
                    <div>
                        <label for="voucher_code">Voucher code</label>
                        <div class="popup-form-input">
                            <input type="text" name="voucher_code" required placeholder="Enter voucher code"
                                class="ducatus-inputs-input" id="voucher_code" [(ngModel)]="voucherCode">
                            <span class="icon icon__settings" (click)="generateCode('v')"></span>
                        </div>
                    </div>
                    <div class="ducatus-inputs-disabled">
                        <label for="activation_code">Activation code</label>
                        <div class="popup-form-input">
                            <input type="text" name="activation_code" disabled placeholder="Enter activation code"
                                class="ducatus-inputs-input" id="activation_code" [(ngModel)]="activationCode">
                            <!-- <span class="icon icon__settings" (click)="generateCode('a')"></span> -->
                            <span class="icon icon__settings"></span>
                        </div>
                    </div>
                    <div class="popup-form-group">
                        <div class="popup-form-group-item">
                            <label for="duc_amount">Amount</label>
                            <div class="popup-form-input">
                                <input type="text" placeholder="Amount" minlength="1" name="duc_amount"
                                    [(ngModel)]="ducAmount" required class="ducatus-inputs-input" id="duc_amount"
                                    oninput="this.value = this.value.replace(/[^0-9](^\,)/g, '').replace(/(\..*)\./g, '$1');">
                                <span class="popup-form-text-label">DUC</span>
                            </div>
                        </div>
                        <div class="popup-form-group-item ducatus-inputs-disabled">
                            <label for="freezeVoucher">Freeze time</label>
                            <div class="popup-form-input">
                                <input [matDatepicker]="picker" disabled class="ducatus-inputs-input"
                                    id="freezeVoucher">
                                <span class="icon icon__datetimepicker"></span>
                                <!-- <span class="icon icon__datetimepicker" (click)="picker.open()"></span> -->
                                <mat-datepicker placeholder="Choose Date" #picker></mat-datepicker>
                            </div>
                        </div>
                    </div>
                    <div class="popup-form-group">
                        <div class="popup-form-group-item">
                            <label class="popup-label" for="is_active">Status</label>
                            <label class="ducatus-inputs-switch">
                                <input type="checkbox" name="is_active" id="is_active" [(ngModel)]="isActive"
                                    [checked]="false">
                                <span class="ducatus-inputs-switch-slider"></span>
                            </label>
                        </div>
                    </div>
                    <button type="submit" [disabled]="voucherAddForm.invalid" class="ducatus-btn ducatus-btn-brown"
                        (click)="addVoucher()">ADD</button>
                </form>
            </div>
        </div>
    </div>
</ng-container>

<ng-container *ngIf="popupModal">
    <div class="popup-voucher">
        <div class="popup-container popup-container-modal">
            <div class="popup-header">
                <span class="popup-header-text">{{ infoModalTitle }}</span>
                <span class="popup-close" (click)="closeInfoModal()">X</span>
            </div>
            <div class="popup-body">
                <span class="popup-body-text" title="{{ infoModalText }}">{{ infoModalText }}</span>
            </div>
        </div>
    </div>
</ng-container>